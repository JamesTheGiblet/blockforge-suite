<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockForge - Text Studio</title>
    <meta name="description" content="Convert text into buildable LEGO signs and displays">
    <script>
        if (window.location.protocol !== 'file:') {
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = '../../manifest.json';
            document.head.appendChild(link);
        }
    </script>
    <meta name="theme-color" content="#004E89">
    <link rel="icon" type="image/png" href="../../public/icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <style>
        /* Reuse core styles for consistency */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-gradient-start: #004E89;
            --bg-gradient-end: #003560;
            --container-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --heading-color: #004E89;
            --accent-color: #FF6B35;
            --border-color: #dddddd;
            --input-bg: #ffffff;
            --panel-bg: #f0f4f8;
        }

        [data-theme="dark"] {
            --bg-gradient-start: #121212;
            --bg-gradient-end: #1e1e1e;
            --container-bg: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #aaaaaa;
            --heading-color: #64b5f6;
            --accent-color: #FF8C61;
            --border-color: #444444;
            --input-bg: #2d2d2d;
            --panel-bg: #262626;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .header-bar {
            max-width: 1200px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }
        .back-btn:hover { background: rgba(255, 255, 255, 0.3); border-color: var(--accent-color); }

        .header-title { color: white; font-size: 24px; font-weight: 700; }
        .header-title .forge { color: var(--accent-color); }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 { text-align: center; color: var(--heading-color); margin-bottom: 10px; font-size: 32px; }
        h1 .forge { color: var(--accent-color); }
        .subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 30px; }

        .input-section {
            background: var(--panel-bg);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid var(--heading-color);
        }

        .text-input {
            width: 100%;
            padding: 15px;
            font-size: 24px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 20px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .controls { display: grid; gap: 15px; margin-bottom: 20px; }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-weight: 600; color: var(--heading-color); font-size: 14px; }
        
        select, input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--heading-color) 0%, var(--bg-gradient-end) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }

        .preview-box {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            background: var(--panel-bg);
            margin-top: 20px;
            overflow: auto;
        }

        canvas {
            display: block;
            margin: 0 auto;
            image-rendering: pixelated;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: var(--panel-bg);
            border-radius: 12px;
            border: 2px solid var(--heading-color);
            text-align: center;
        }
        .stat-value { font-size: 20px; font-weight: 700; color: var(--heading-color); }
        .stat-label { font-size: 12px; color: var(--text-secondary); }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: auto;
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <a href="../../index.html" class="back-btn">‚Üê Back to BlockForge</a>
        <div class="header-title">BLOCK<span class="forge">FORGE</span> - Text Studio</div>
        <button class="theme-toggle" id="themeToggle">üåô</button>
    </div>

    <div class="container">
        <h1>üìù Text <span class="forge">Studio</span></h1>
        <p class="subtitle">Transform text into buildable LEGO signs with optimized typography</p>

        <div class="input-section">
            <input type="text" id="textInput" class="text-input" placeholder="Type your text here..." value="LEGO">
            
            <div class="controls" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="control-group">
                    <label>Font Style</label>
                    <select id="fontSelect" title="Font Style">
                        <option value="Arial">Sans Serif (Arial)</option>
                        <option value="Times New Roman">Serif (Times)</option>
                        <option value="Courier New">Monospace (Code)</option>
                        <option value="Impact">Bold (Impact)</option>
                        <option value="Comic Sans MS">Playful (Comic)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Text Height (studs)</label>
                    <input type="number" id="heightInput" value="16" min="8" max="64" title="Enter the text height in LEGO studs" placeholder="Text height (studs)">
                </div>
                <div class="control-group">
                    <label>Text Color</label>
                    <select id="textColorSelect" title="Text Color">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div class="control-group">
                    <label for="bgColorSelect">Background Color</label>
                    <select id="bgColorSelect">
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>
            
            <button id="generateBtn">Generate Sign</button>
            <button id="downloadBtn" style="margin-top: 10px; background: var(--accent-color);">üì• Save as Image</button>
        </div>

        <div class="preview-box">
            <canvas id="legoCanvas"></canvas>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-label">Dimensions</div>
                <div class="stat-value" id="dimensions">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Total Parts</div>
                <div class="stat-value" id="totalParts">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Est. Cost</div>
                <div class="stat-value" id="estCost">-</div>
            </div>
        </div>
    </div>

    <script src="../../shared/blockforge-core.js"></script>
    <script>
        // LEGO Colors Definition
        const LEGO_COLORS = {
            "Red": [201, 26, 9],
            "Blue": [0, 85, 191],
            "Yellow": [255, 205, 3],
            "Green": [0, 158, 96],
            "White": [255, 255, 255],
            "Black": [5, 19, 29],
            "Light Bluish Gray": [156, 163, 168],
            "Dark Bluish Gray": [99, 95, 97],
            "Reddish Brown": [88, 42, 18],
            "Dark Brown": [53, 33, 0],
            "Dark Tan": [137, 125, 98],
            "Medium Brown": [115, 84, 58],
            "Reddish Orange": [202, 76, 11],
            "Orange": [255, 127, 0],
            "Dark Orange": [168, 61, 21],
            "Dark Red": [114, 0, 18],
            "Coral": [255, 109, 119],
            "Dark Pink": [222, 55, 139],
            "Bright Pink": [255, 151, 204],
            "Medium Dark Pink": [247, 133, 177],
            "Purple": [129, 0, 123],
            "Dark Purple": [63, 26, 86],
            "Magenta": [146, 57, 120],
            "Medium Lavender": [172, 120, 186],
            "Lavender": [205, 164, 222],
            "Dark Blue": [0, 32, 96],
            "Medium Blue": [97, 175, 255],
            "Medium Azure": [54, 174, 191],
            "Light Aqua": [204, 255, 255],
            "Dark Azure": [70, 155, 195],
            "Bright Light Blue": [159, 195, 233],
            "Sand Blue": [112, 129, 154],
            "Dark Green": [0, 69, 26],
            "Sand Green": [112, 142, 124],
            "Olive Green": [122, 124, 69],
            "Lime": [190, 214, 0],
            "Yellowish Green": [226, 249, 154],
            "Tan": [222, 198, 156],
            "Light Nougat": [254, 204, 176],
            "Medium Nougat": [170, 125, 85],
            "Nougat": [204, 142, 105],
            "Dark Nougat": [170, 104, 66],
            "Flat Silver": [140, 140, 140],
            "Metallic Silver": [140, 140, 140],
            "Pearl Gold": [220, 188, 129]
        };

        const textInput = document.getElementById('textInput');
        const fontSelect = document.getElementById('fontSelect');
        const heightInput = document.getElementById('heightInput');
        const textColorSelect = document.getElementById('textColorSelect');
        const bgColorSelect = document.getElementById('bgColorSelect');
        const generateBtn = document.getElementById('generateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const canvas = document.getElementById('legoCanvas');
        const ctx = canvas.getContext('2d');

        // Theme Logic
        const toggleBtn = document.getElementById('themeToggle');
        const html = document.documentElement;
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        html.setAttribute('data-theme', savedTheme);
        toggleBtn.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

        toggleBtn.addEventListener('click', () => {
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            toggleBtn.textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        });

        // Populate Selects
        function populateColorSelects() {
            const options = Object.keys(LEGO_COLORS).sort().map(color => 
                `<option value="${color}">${color}</option>`
            ).join('');
            
            textColorSelect.innerHTML = options;
            bgColorSelect.innerHTML = `<option value="none">None (Transparent)</option>` + options;
            
            // Set defaults
            textColorSelect.value = 'Black';
            bgColorSelect.value = 'Light Bluish Gray';
        }
        populateColorSelects();

        function generateSign() {
            const text = textInput.value.toUpperCase();
            if (!text) return;

            const height = parseInt(heightInput.value);
            const font = fontSelect.value;
            const textColorName = textColorSelect.value;
            const bgColorName = bgColorSelect.value;

            // 1. Create a temporary canvas to render high-res text
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // Set font to measure width
            tempCtx.font = `bold ${height}px ${font}`;
            const metrics = tempCtx.measureText(text);
            const width = Math.ceil(metrics.width);
            
            // Resize temp canvas
            tempCanvas.width = width;
            tempCanvas.height = height; // Exact height match for 1:1 pixel mapping
            
            // Draw Background
            if (bgColorName !== 'none') {
                const bgRgb = LEGO_COLORS[bgColorName];
                tempCtx.fillStyle = `rgb(${bgRgb[0]}, ${bgRgb[1]}, ${bgRgb[2]})`;
                tempCtx.fillRect(0, 0, width, height);
            } else {
                tempCtx.clearRect(0, 0, width, height);
            }

            // Draw Text
            const textRgb = LEGO_COLORS[textColorName];
            tempCtx.fillStyle = `rgb(${textRgb[0]}, ${textRgb[1]}, ${textRgb[2]})`;
            tempCtx.font = `bold ${height * 0.8}px ${font}`; // Slightly smaller to fit vertically
            tempCtx.textBaseline = 'middle';
            tempCtx.textAlign = 'center';
            tempCtx.fillText(text, width / 2, height / 2);

            // 2. Process pixels to LEGO grid
            const imageData = tempCtx.getImageData(0, 0, width, height);
            const pixels = imageData.data;
            
            // Resize display canvas (scale up for visibility)
            const scale = 20;
            canvas.width = width * scale;
            canvas.height = height * scale;
            
            // Draw Grid
            let partCount = 0;
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const i = (y * width + x) * 4;
                    const r = pixels[i];
                    const g = pixels[i+1];
                    const b = pixels[i+2];
                    const a = pixels[i+3];

                    let fillStyle = null;

                    // Simple threshold for text vs background
                    // If alpha is low, it's transparent
                    if (a < 128) {
                        if (bgColorName !== 'none') {
                            const bg = LEGO_COLORS[bgColorName];
                            fillStyle = `rgb(${bg[0]}, ${bg[1]}, ${bg[2]})`;
                        }
                    } else {
                        // Determine if it's closer to text color or background
                        const textDist = Math.abs(r - textRgb[0]) + Math.abs(g - textRgb[1]) + Math.abs(b - textRgb[2]);
                        
                        if (textDist < 150) {
                            fillStyle = `rgb(${textRgb[0]}, ${textRgb[1]}, ${textRgb[2]})`;
                            partCount++;
                        } else if (bgColorName !== 'none') {
                            const bg = LEGO_COLORS[bgColorName];
                            fillStyle = `rgb(${bg[0]}, ${bg[1]}, ${bg[2]})`;
                        }
                    }

                    if (fillStyle) {
                        ctx.fillStyle = fillStyle;
                        ctx.fillRect(x * scale, y * scale, scale, scale);
                        
                        // Stud effect
                        ctx.fillStyle = 'rgba(0,0,0,0.1)';
                        ctx.beginPath();
                        ctx.arc(x * scale + scale/2, y * scale + scale/2, scale * 0.3, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    // Grid lines
                    ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                    ctx.strokeRect(x * scale, y * scale, scale, scale);
                }
            }

            // Update Stats
            document.getElementById('dimensions').textContent = `${width} √ó ${height}`;
            document.getElementById('totalParts').textContent = partCount;
            document.getElementById('estCost').textContent = `$${(partCount * 0.06).toFixed(2)}`;
        }

        generateBtn.addEventListener('click', generateSign);
        
        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = `blockforge-text-${textInput.value || 'sign'}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });

        // Initial generation
        window.onload = generateSign;

        // PWA installation
        if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {
                    console.log('Service worker registration optional');
                });
            });
        }
    </script>
</body>
</html>
```

<!--
[PROMPT_SUGGESTION]How do I add a "Save as Image" button to the Text Studio?[/PROMPT_SUGGESTION]
[PROMPT_SUGGESTION]Can you explain how the text rendering logic works in the Text Studio?[/PROMPT_SUGGESTION]
